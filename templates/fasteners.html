{% extends "base.html" %}

{% block title %}Fasteners - Toolshed App{% endblock %}

{% block content %}
<div class="flex justify-between align-center mb-30">
    <h1 class="section-header">Fasteners Collection</h1>
    <div style="display: flex; gap: 15px;">
        <a href="{{ url_for('fastener_wizard') }}" class="btn btn-purple">‚ú® Quick Wizard</a>
        <a href="{{ url_for('add_fastener') }}" class="btn btn-blue">+ Manual Entry</a>
    </div>
</div>

<!-- Low Stock Alert -->
{% if low_stock %}
<div class="glass" style="padding: 24px; margin-bottom: 32px; border-radius: 16px; border-left: 4px solid var(--warning);">
    <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 700; color: var(--warning); font-family: var(--font-display);">‚ö†Ô∏è Low Stock Alert</h3>
    <div style="display: grid; gap: 12px;">
        {% for item in low_stock %}
        <div class="low-stock-item">
            <div>
                <div class="low-stock-name">{{ item.category }} - {{ item.size }}{% if item.length %} x {{ item.length }}{% endif %}</div>
            </div>
            <div class="low-stock-qty">
                {{ item.quantity }} / {{ item.min_quantity }} min
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Search and Filter -->
<div class="search-bar">
    <form method="GET" action="{{ url_for('fasteners') }}" style="display: grid; grid-template-columns: 1fr auto auto auto auto; gap: 15px;">
        <input type="text"
               name="search"
               class="search-input"
               placeholder="Search size, material, head type, location..."
               value="{{ search }}">

        <select name="category" class="form-select" style="min-width: 180px;">
            <option value="">All Categories</option>
            {% for cat in categories %}
            <option value="{{ cat.category }}" {% if cat.category == current_category %}selected{% endif %}>
                {{ cat.category }}
            </option>
            {% endfor %}
        </select>

        <select name="location" class="form-select" style="min-width: 150px;">
            <option value="">All Locations</option>
            {% for loc in locations %}
            <option value="{{ loc.location }}" {% if loc.location == current_location %}selected{% endif %}>
                {{ loc.location }}
            </option>
            {% endfor %}
        </select>

        <button type="submit" class="btn">Search</button>
        {% if search or current_category or current_location %}
        <a href="{{ url_for('fasteners') }}" class="btn">Clear</a>
        {% endif %}
    </form>
</div>

<!-- Bulk Actions Bar -->
<div id="bulkActionsBar" style="display: none; position: sticky; top: 0; z-index: 100; background: linear-gradient(135deg, var(--accent-purple), #ec4899); padding: 16px 24px; border-radius: 12px; margin-bottom: 24px; color: white; align-items: center; gap: 16px;">
    <span id="selectedCount" style="font-weight: 600; font-family: var(--font-display);">0 items selected</span>
    <button onclick="printSelectedLabels()" class="btn" style="background: white; color: var(--accent-purple); padding: 8px 20px;">
        üñ®Ô∏è Print Labels
    </button>
    <button onclick="clearSelection()" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 8px 20px;">
        Clear Selection
    </button>
</div>

{% if fasteners %}
<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent-purple);">
                </th>
                <th>Image</th>
                <th>Category</th>
                <th>Size</th>
                <th>Length</th>
                <th>Material</th>
                <th>Head Type</th>
                <th>Stock</th>
                <th>Location</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for fastener in fasteners %}
            <tr style="cursor: pointer;" onclick="window.location='{{ url_for('fastener_detail', fastener_id=fastener.id) }}';">
                <td onclick="event.stopPropagation();">
                    <input type="checkbox" class="item-checkbox" data-type="fastener" data-id="{{ fastener.id }}" onchange="updateBulkActions()" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent-purple);">
                </td>
                <td>
                    {% if fastener.image_path %}
                    <img src="{{ url_for('static', filename=fastener.image_path) }}"
                         alt="{{ fastener.category }}"
                         style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-glass);">
                    {% else %}
                    <div style="width: 50px; height: 50px; background: var(--bg-glass); display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 1px solid var(--border-glass); font-size: 24px;">
                        üî©
                    </div>
                    {% endif %}
                </td>
                <td style="padding: 12px;">
                    <div style="font-weight: 600;">{{ fastener.fastener_type }}</div>
                    {% if fastener.thread_type %}
                    <div style="font-size: 12px; color: var(--text-secondary);">{{ fastener.thread_type }}</div>
                    {% endif %}
                </td>
                <td style="padding: 12px; font-family: var(--font-mono);"><strong>{{ fastener.diameter }}mm</strong></td>
                <td style="padding: 12px; font-family: var(--font-mono);">{{ fastener.length }}mm</td>
                <td style="padding: 12px;">{{ fastener.material or '-' }}</td>
                <td style="padding: 12px;">{{ fastener.head_type or '-' }}</td>
                <td style="padding: 12px;">
                    {% if fastener.min_quantity and fastener.quantity <= fastener.min_quantity %}
                    <span style="color: var(--warning); font-weight: 600; font-family: var(--font-mono);">{{ fastener.quantity }}</span>
                    {% else %}
                    <span style="font-family: var(--font-mono);">{{ fastener.quantity }}</span>
                    {% endif %}
                    {% if fastener.min_quantity %}
                    <span style="font-size: 12px; color: var(--text-secondary);"> / {{ fastener.min_quantity }} min</span>
                    {% endif %}
                </td>
                <td style="padding: 12px;">{{ fastener.location or '-' }}</td>
                <td style="padding: 12px;" onclick="event.stopPropagation();">
                    <div style="display: flex; gap: 6px;">
                        <a href="{{ url_for('edit_fastener', fastener_id=fastener.id) }}" class="btn" style="padding: 6px 12px; font-size: 12px;" title="Edit">‚úèÔ∏è</a>
                        <a href="{{ url_for('labels', **{'fasteners[]': fastener.id}) }}" class="btn" style="padding: 6px 12px; font-size: 12px;" title="Print Label" target="_blank">üñ®Ô∏è</a>
                        <a href="{{ url_for('duplicate_fastener', fastener_id=fastener.id) }}" class="btn" style="padding: 6px 12px; font-size: 12px;" title="Duplicate">üìã</a>
                        <form method="POST" action="{{ url_for('delete_fastener', fastener_id=fastener.id) }}" style="margin: 0; display: inline;" onsubmit="return confirm('Delete this fastener?');">
                            <button type="submit" class="btn" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, var(--danger), #dc2626);" title="Delete">üóëÔ∏è</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center" style="padding: 60px 20px;">
    <div style="font-size: 48px; margin-bottom: 20px;">üî©</div>
    <h2 style="font-family: var(--font-display); font-size: 24px; margin-bottom: 10px;">No fasteners found</h2>
    <p style="color: var(--text-secondary); margin-bottom: 20px;">
        {% if search or current_category or current_location %}
        Try adjusting your search or filters
        {% else %}
        Start organizing your screw and bolt collection
        {% endif %}
    </p>
    <a href="{{ url_for('add_fastener') }}" class="btn btn-primary">Add Your First Fastener</a>
</div>
{% endif %}

<script>
function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    const bulkBar = document.getElementById('bulkActionsBar');
    const countSpan = document.getElementById('selectedCount');
    const selectAll = document.getElementById('selectAll');

    if (checkboxes.length > 0) {
        bulkBar.style.display = 'flex';
        countSpan.textContent = `${checkboxes.length} item${checkboxes.length > 1 ? 's' : ''} selected`;
    } else {
        bulkBar.style.display = 'none';
    }

    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.item-checkbox');
    selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
}

function toggleSelectAll(checkbox) {
    document.querySelectorAll('.item-checkbox').forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateBulkActions();
}

function printSelectedLabels() {
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    const params = new URLSearchParams();

    checkboxes.forEach(cb => {
        const type = cb.dataset.type;
        const id = cb.dataset.id;
        params.append(`${type}s[]`, id);
    });

    window.open(`{{ url_for('labels') }}?${params.toString()}`, '_blank');
}

function clearSelection() {
    document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    updateBulkActions();
}
</script>
{% endblock %}
