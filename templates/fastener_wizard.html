{% extends "base.html" %}

{% block title %}Add Fastener - Wizard - Toolshed App{% endblock %}

{% block content %}
<div class="flex justify-between align-center mb-30">
    <h1 class="section-header">Add Fastener - Quick Wizard</h1>
    <div style="display: flex; gap: 15px;">
        <a href="{{ url_for('add_fastener') }}" class="btn">Use Regular Form</a>
        <a href="{{ url_for('fasteners') }}" class="btn">Cancel</a>
    </div>
</div>

<div style="max-width: 900px; margin: 0 auto;">
    <!-- Progress Bar -->
    <div style="background: var(--bg-primary); padding: 20px; margin-bottom: 30px; border: 2px solid var(--border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style="font-size: 14px; color: var(--text-secondary);">Step <span id="current-step">1</span> of 7</div>
            <div style="font-size: 14px; color: var(--primary);" id="step-title">Category</div>
        </div>
        <div style="height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
            <div id="progress-bar" style="height: 100%; background: var(--primary); width: 14%; transition: width 0.3s;"></div>
        </div>
    </div>

    <!-- Wizard Form -->
    <form method="POST" action="{{ url_for('add_fastener') }}" enctype="multipart/form-data" id="wizard-form">
        <!-- Hidden inputs to store selections -->
        <input type="hidden" name="category" id="final-category">
        <input type="hidden" name="size" id="final-size">
        <input type="hidden" name="length" id="final-length">
        <input type="hidden" name="material" id="final-material">
        <input type="hidden" name="head_type" id="final-head-type">
        <input type="hidden" name="thread_type" id="final-thread-type">
        <input type="hidden" name="quantity" id="final-quantity">
        <input type="hidden" name="min_quantity" id="final-min-quantity">
        <input type="hidden" name="location" id="final-location">
        <input type="hidden" name="notes" id="final-notes">

        <!-- Step 1: Main Category -->
        <div class="wizard-step active" data-step="1">
            <h2 style="font-size: 24px; margin-bottom: 20px; text-align: center;">What type of fastener?</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <button type="button" class="wizard-option" data-value="Screw" data-next="2">
                    <div style="font-size: 36px; margin-bottom: 10px;">üî©</div>
                    <div style="font-weight: 600;">Screw</div>
                </button>
                <button type="button" class="wizard-option" data-value="Bolt" data-next="2">
                    <div style="font-size: 36px; margin-bottom: 10px;">üî©</div>
                    <div style="font-weight: 600;">Bolt</div>
                </button>
                <button type="button" class="wizard-option" data-value="Nut" data-next="3">
                    <div style="font-size: 36px; margin-bottom: 10px;">‚¨°</div>
                    <div style="font-weight: 600;">Nut</div>
                </button>
                <button type="button" class="wizard-option" data-value="Washer" data-next="3">
                    <div style="font-size: 36px; margin-bottom: 10px;">‚≠ï</div>
                    <div style="font-weight: 600;">Washer</div>
                </button>
                <button type="button" class="wizard-option" data-value="Anchor" data-next="3">
                    <div style="font-size: 36px; margin-bottom: 10px;">üìå</div>
                    <div style="font-weight: 600;">Anchor</div>
                </button>
                <button type="button" class="wizard-option" data-value="Rivet" data-next="3">
                    <div style="font-size: 36px; margin-bottom: 10px;">‚ö´</div>
                    <div style="font-weight: 600;">Rivet</div>
                </button>
            </div>
        </div>

        <!-- Step 2: Screw/Bolt Type -->
        <div class="wizard-step" data-step="2">
            <h2 style="font-size: 24px; margin-bottom: 20px; text-align: center;">What type of <span id="type-name"></span>?</h2>
            <div id="subtypes-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;"></div>
        </div>

        <!-- Step 3: Size -->
        <div class="wizard-step" data-step="3">
            <h2 style="font-size: 24px; margin-bottom: 10px; text-align: center;">What size?</h2>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">‚ú® Select multiple sizes to add them all at once</p>
            <div id="size-count" style="text-align: center; color: var(--primary); font-weight: 600; margin-bottom: 20px; min-height: 24px;"></div>
            <div style="background: var(--bg-secondary); padding: 30px; border: 2px solid var(--border); margin-bottom: 20px;">
                <input type="text" id="size-input" class="form-input"
                       placeholder="Type size: M4, M5, M6, #8, #10, 1/4&quot;... (press Enter to add)"
                       style="font-size: 18px; text-align: center;">
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 20px;">
                <button type="button" class="wizard-option size-option multi-select" data-value="M3">M3</button>
                <button type="button" class="wizard-option size-option multi-select" data-value="M4">M4</button>
                <button type="button" class="wizard-option size-option multi-select" data-value="M5">M5</button>
                <button type="button" class="wizard-option size-option multi-select" data-value="M6">M6</button>
                <button type="button" class="wizard-option size-option multi-select" data-value="M8">M8</button>
                <button type="button" class="wizard-option size-option multi-select" data-value="M10">M10</button>
                <button type="button" class="wizard-option size-option multi-select" data-value="#6">#6</button>
                <button type="button" class="wizard-option size-option multi-select" data-value="#8">#8</button>
                <button type="button" class="wizard-option size-option multi-select" data-value="#10">#10</button>
                <button type="button" class="wizard-option size-option multi-select" data-value="#12">#12</button>
                <button type="button" class="wizard-option size-option multi-select" data-value="1/4&quot;">1/4"</button>
                <button type="button" class="wizard-option size-option multi-select" data-value="5/16&quot;">5/16"</button>
            </div>
            <div style="text-align: center;">
                <button type="button" id="size-next-btn" class="btn btn-primary" style="display: none; min-width: 200px;" onclick="goToStep(4)">Next with <span id="size-selected-count">0</span> sizes ‚Üí</button>
            </div>
        </div>

        <!-- Step 4: Length -->
        <div class="wizard-step" data-step="4">
            <h2 style="font-size: 24px; margin-bottom: 10px; text-align: center;">What length?</h2>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">‚ú® Select multiple lengths to add them all at once</p>
            <div id="length-count" style="text-align: center; color: var(--primary); font-weight: 600; margin-bottom: 20px; min-height: 24px;"></div>
            <div style="background: var(--bg-secondary); padding: 30px; border: 2px solid var(--border); margin-bottom: 20px;">
                <input type="text" id="length-input" class="form-input"
                       placeholder="Type length: 10mm, 25mm, 1&quot;, 2&quot;... (press Enter to add)"
                       style="font-size: 18px; text-align: center;">
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 20px;">
                <button type="button" class="wizard-option length-option multi-select" data-value="10mm">10mm</button>
                <button type="button" class="wizard-option length-option multi-select" data-value="15mm">15mm</button>
                <button type="button" class="wizard-option length-option multi-select" data-value="20mm">20mm</button>
                <button type="button" class="wizard-option length-option multi-select" data-value="25mm">25mm</button>
                <button type="button" class="wizard-option length-option multi-select" data-value="30mm">30mm</button>
                <button type="button" class="wizard-option length-option multi-select" data-value="40mm">40mm</button>
                <button type="button" class="wizard-option length-option multi-select" data-value="50mm">50mm</button>
                <button type="button" class="wizard-option length-option multi-select" data-value="1&quot;">1"</button>
                <button type="button" class="wizard-option length-option multi-select" data-value="1.5&quot;">1.5"</button>
                <button type="button" class="wizard-option length-option multi-select" data-value="2&quot;">2"</button>
                <button type="button" class="wizard-option length-option multi-select" data-value="2.5&quot;">2.5"</button>
                <button type="button" class="wizard-option length-option multi-select" data-value="3&quot;">3"</button>
            </div>
            <div style="text-align: center; display: flex; gap: 15px; justify-content: center;">
                <button type="button" id="length-next-btn" class="btn btn-primary" style="display: none; min-width: 200px;" onclick="goToStep(5)">Next with <span id="length-selected-count">0</span> lengths ‚Üí</button>
                <button type="button" class="btn" onclick="skipLengthStep()" style="min-width: 150px;">Skip (N/A)</button>
            </div>
        </div>

        <!-- Step 5: Material -->
        <div class="wizard-step" data-step="5">
            <h2 style="font-size: 24px; margin-bottom: 20px; text-align: center;">What material?</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <button type="button" class="wizard-option" data-value="Stainless Steel">Stainless Steel</button>
                <button type="button" class="wizard-option" data-value="Zinc Plated">Zinc Plated</button>
                <button type="button" class="wizard-option" data-value="Galvanized">Galvanized</button>
                <button type="button" class="wizard-option" data-value="Black Oxide">Black Oxide</button>
                <button type="button" class="wizard-option" data-value="Brass">Brass</button>
                <button type="button" class="wizard-option" data-value="Plain Steel">Plain Steel</button>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button type="button" class="wizard-option" onclick="skipStep()" style="display: inline-block; min-width: 200px;">Skip</button>
            </div>
        </div>

        <!-- Step 6: Head Type -->
        <div class="wizard-step" data-step="6">
            <h2 style="font-size: 24px; margin-bottom: 20px; text-align: center;">What head/drive type?</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <button type="button" class="wizard-option" data-value="Phillips">Phillips</button>
                <button type="button" class="wizard-option" data-value="Flat Head">Flat Head</button>
                <button type="button" class="wizard-option" data-value="Hex">Hex</button>
                <button type="button" class="wizard-option" data-value="Torx">Torx</button>
                <button type="button" class="wizard-option" data-value="Robertson (Square)">Robertson</button>
                <button type="button" class="wizard-option" data-value="Allen (Hex Socket)">Allen</button>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button type="button" class="wizard-option" onclick="skipStep()" style="display: inline-block; min-width: 200px;">Skip</button>
            </div>
        </div>

        <!-- Step 7: Final Details -->
        <div class="wizard-step" data-step="7">
            <h2 style="font-size: 24px; margin-bottom: 10px; text-align: center;">Almost done! Add quantity and location</h2>
            <p id="fastener-count-message" style="text-align: center; color: var(--primary); font-weight: 600; font-size: 18px; margin-bottom: 30px;"></p>

            <!-- Summary Box -->
            <div style="background: var(--bg-primary); border: 2px solid var(--primary); padding: 20px; margin-bottom: 30px;">
                <h3 style="font-size: 18px; margin-bottom: 15px; color: var(--primary);">Summary</h3>
                <div id="summary-content" style="display: grid; grid-template-columns: auto 1fr; gap: 10px 20px; font-size: 15px;"></div>
            </div>

            <div style="background: var(--bg-secondary); padding: 30px; border: 2px solid var(--border);">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label" for="qty-input">Quantity</label>
                        <input type="number" id="qty-input" class="form-input" min="0" value="0" step="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="min-qty-input">Min Quantity Alert</label>
                        <input type="number" id="min-qty-input" class="form-input" min="0" step="1" placeholder="e.g., 10">
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" for="loc-input">Storage Location</label>
                    <input type="text" id="loc-input" class="form-input" placeholder="e.g., Drawer 3 Bin A2">
                </div>

                <div class="form-group">
                    <label class="form-label" for="notes-input">Notes (Optional)</label>
                    <textarea id="notes-input" class="form-textarea" rows="3" placeholder="Additional notes..."></textarea>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div style="display: flex; justify-content: space-between; margin-top: 30px;">
            <button type="button" id="back-btn" class="btn" style="display: none;" onclick="previousStep()">‚Üê Back</button>
            <div style="flex: 1;"></div>
            <button type="button" id="next-btn" class="btn btn-primary" style="display: none;">Next ‚Üí</button>
            <button type="submit" id="submit-btn" class="btn btn-primary" style="display: none;">Add Fastener</button>
        </div>
    </form>
</div>

<style>
.wizard-step {
    display: none;
}

.wizard-step.active {
    display: block;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.wizard-option {
    background: var(--bg-secondary);
    border: 2px solid var(--border);
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text-primary);
    font-size: 16px;
}

.wizard-option:hover {
    background: var(--bg-primary);
    border-color: var(--primary);
    transform: translateY(-2px);
}

.wizard-option.selected {
    background: var(--bg-primary);
    border-color: var(--primary);
    border-width: 3px;
}
</style>

{% endblock %}

{% block scripts %}
<script>
let currentStep = 1;
let selections = {
    mainType: '',
    category: '',
    sizes: [],  // Changed to array for multi-select
    lengths: [], // Changed to array for multi-select
    material: '',
    headType: '',
    threadType: '',
    quantity: 0,
    minQuantity: '',
    location: '',
    notes: ''
};

const stepTitles = {
    1: 'Category',
    2: 'Type',
    3: 'Size',
    4: 'Length',
    5: 'Material',
    6: 'Head Type',
    7: 'Details'
};

const subtypes = {
    'Screw': ['Wood Screw', 'Machine Screw', 'Self-Tapping Screw', 'Sheet Metal Screw', 'Drywall Screw', 'Deck Screw', 'Concrete Screw'],
    'Bolt': ['Hex Bolt', 'Carriage Bolt', 'Eye Bolt', 'U-Bolt']
};

document.addEventListener('DOMContentLoaded', function() {
    updateProgress();
    loadLastLocation();

    // Handle main category buttons
    document.querySelectorAll('[data-step="1"] .wizard-option').forEach(btn => {
        btn.addEventListener('click', function() {
            const value = this.dataset.value;
            const nextStep = parseInt(this.dataset.next);
            selections.mainType = value;

            if (nextStep === 2) {
                showSubtypes(value);
                goToStep(2);
            } else {
                selections.category = value;
                goToStep(3);
            }
        });
    });

    // Handle size multi-select
    document.getElementById('size-input').addEventListener('keyup', function(e) {
        if (e.key === 'Enter' && this.value.trim()) {
            toggleSize(this.value.trim());
            this.value = '';
        }
    });

    document.querySelectorAll('.size-option.multi-select').forEach(btn => {
        btn.addEventListener('click', function() {
            toggleSize(this.dataset.value);
        });
    });

    // Handle length multi-select
    document.getElementById('length-input').addEventListener('keyup', function(e) {
        if (e.key === 'Enter' && this.value.trim()) {
            toggleLength(this.value.trim());
            this.value = '';
        }
    });

    document.querySelectorAll('.length-option.multi-select').forEach(btn => {
        btn.addEventListener('click', function() {
            toggleLength(this.dataset.value);
        });
    });

    // Handle material, head type buttons
    document.querySelectorAll('[data-step="5"] .wizard-option, [data-step="6"] .wizard-option').forEach(btn => {
        btn.addEventListener('click', function() {
            const step = this.closest('.wizard-step').dataset.step;
            const value = this.dataset.value;

            if (step == 5) {
                selections.material = value;
                goToStep(6);
            } else if (step == 6) {
                selections.headType = value;
                goToStep(7);
            }
        });
    });

    // Handle final inputs
    document.getElementById('qty-input').addEventListener('input', function() {
        selections.quantity = this.value;
    });

    document.getElementById('min-qty-input').addEventListener('input', function() {
        selections.minQuantity = this.value;
    });

    document.getElementById('loc-input').addEventListener('input', function() {
        selections.location = this.value;
    });

    document.getElementById('notes-input').addEventListener('input', function() {
        selections.notes = this.value;
    });

    // Handle form submission
    document.getElementById('wizard-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitBatch();
    });
});

function toggleSize(value) {
    const index = selections.sizes.indexOf(value);
    if (index > -1) {
        selections.sizes.splice(index, 1);
    } else {
        selections.sizes.push(value);
    }
    updateSizeUI();
}

function toggleLength(value) {
    const index = selections.lengths.indexOf(value);
    if (index > -1) {
        selections.lengths.splice(index, 1);
    } else {
        selections.lengths.push(value);
    }
    updateLengthUI();
}

function updateSizeUI() {
    document.querySelectorAll('.size-option').forEach(btn => {
        if (selections.sizes.includes(btn.dataset.value)) {
            btn.classList.add('selected');
        } else {
            btn.classList.remove('selected');
        }
    });

    const count = selections.sizes.length;
    const countEl = document.getElementById('size-count');
    const nextBtn = document.getElementById('size-next-btn');
    const selectedCountEl = document.getElementById('size-selected-count');

    if (count > 0) {
        countEl.textContent = 'Selected: ' + selections.sizes.join(', ');
        nextBtn.style.display = 'block';
        selectedCountEl.textContent = count;
    } else {
        countEl.textContent = '';
        nextBtn.style.display = 'none';
    }
}

function updateLengthUI() {
    document.querySelectorAll('.length-option').forEach(btn => {
        if (selections.lengths.includes(btn.dataset.value)) {
            btn.classList.add('selected');
        } else {
            btn.classList.remove('selected');
        }
    });

    const count = selections.lengths.length;
    const countEl = document.getElementById('length-count');
    const nextBtn = document.getElementById('length-next-btn');
    const selectedCountEl = document.getElementById('length-selected-count');

    if (count > 0) {
        countEl.textContent = 'Selected: ' + selections.lengths.join(', ');
        nextBtn.style.display = 'block';
        selectedCountEl.textContent = count;
    } else {
        countEl.textContent = '';
        nextBtn.style.display = 'none';
    }
}

function loadLastLocation() {
    const lastLocation = localStorage.getItem('lastFastenerLocation');
    if (lastLocation) {
        document.getElementById('loc-input').value = lastLocation;
        selections.location = lastLocation;
    }
}

function showSubtypes(mainType) {
    const container = document.getElementById('subtypes-container');
    const types = subtypes[mainType] || [];

    container.innerHTML = '';
    document.getElementById('type-name').textContent = mainType.toLowerCase();

    types.forEach(type => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'wizard-option';
        btn.textContent = type;
        btn.addEventListener('click', function() {
            selections.category = type;
            goToStep(3);
        });
        container.appendChild(btn);
    });
}

function goToStep(step) {
    currentStep = step;

    // Hide all steps
    document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));

    // Show current step
    document.querySelector(`[data-step="${step}"]`).classList.add('active');

    // Update progress
    updateProgress();

    // Update buttons
    document.getElementById('back-btn').style.display = step > 1 ? 'block' : 'none';
    document.getElementById('next-btn').style.display = 'none';
    document.getElementById('submit-btn').style.display = step === 7 ? 'block' : 'none';

    // Show summary on last step
    if (step === 7) {
        updateSummary();
    }

    // Scroll to top
    window.scrollTo(0, 0);
}

function previousStep() {
    if (currentStep > 1) {
        goToStep(currentStep - 1);
    }
}

function skipStep() {
    goToStep(currentStep + 1);
}

function skipLengthStep() {
    selections.lengths = [];
    goToStep(5);
}

function updateProgress() {
    const progress = (currentStep / 7) * 100;
    document.getElementById('progress-bar').style.width = progress + '%';
    document.getElementById('current-step').textContent = currentStep;
    document.getElementById('step-title').textContent = stepTitles[currentStep];
}

function updateSummary() {
    const summary = document.getElementById('summary-content');
    let html = '';

    if (selections.category) {
        html += `<strong>Type:</strong><span>${selections.category}</span>`;
    }
    if (selections.sizes.length > 0) {
        html += `<strong>Sizes:</strong><span>${selections.sizes.join(', ')}</span>`;
    }
    if (selections.lengths.length > 0) {
        html += `<strong>Lengths:</strong><span>${selections.lengths.join(', ')}</span>`;
    }
    if (selections.material) {
        html += `<strong>Material:</strong><span>${selections.material}</span>`;
    }
    if (selections.headType) {
        html += `<strong>Head Type:</strong><span>${selections.headType}</span>`;
    }

    summary.innerHTML = html;
    updateFastenerCount();
}

function updateFastenerCount() {
    const sizeCount = selections.sizes.length || 1;
    const lengthCount = selections.lengths.length || 1;
    const totalCount = sizeCount * lengthCount;

    const message = document.getElementById('fastener-count-message');
    if (totalCount > 1) {
        message.textContent = `You're about to add ${totalCount} fastener entries (${sizeCount} size${sizeCount > 1 ? 's' : ''} √ó ${lengthCount} length${lengthCount > 1 ? 's' : ''})`;
    } else {
        message.textContent = `You're about to add 1 fastener entry`;
    }
}

function saveLastLocation() {
    if (selections.location) {
        localStorage.setItem('lastFastenerLocation', selections.location);
    }
}

async function submitBatch() {
    // Save location for next time
    saveLastLocation();

    // Create all combinations of sizes and lengths
    const fasteners = [];
    const sizes = selections.sizes.length > 0 ? selections.sizes : [''];
    const lengths = selections.lengths.length > 0 ? selections.lengths : [''];

    for (const size of sizes) {
        for (const length of lengths) {
            fasteners.push({
                category: selections.category,
                size: size,
                length: length || null,
                material: selections.material || null,
                head_type: selections.headType || null,
                thread_type: selections.threadType || null,
                quantity: parseInt(selections.quantity) || 0,
                min_quantity: selections.minQuantity ? parseInt(selections.minQuantity) : null,
                location: selections.location || null,
                notes: selections.notes || null
            });
        }
    }

    // Show loading state
    const submitBtn = document.getElementById('submit-btn');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    try {
        const response = await fetch('/fastener/batch-add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ fasteners: fasteners })
        });

        const result = await response.json();

        if (result.success) {
            window.location.href = '/fasteners';
        } else {
            alert('Error adding fasteners. Please try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error adding fasteners. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}
</script>
{% endblock %}
