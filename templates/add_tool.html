{% extends "base.html" %}

{% block title %}Add Tool - Toolshed App{% endblock %}

{% block content %}
<div class="flex justify-between align-center mb-30">
    <h1 class="section-header">Add New Tool</h1>
    <a href="{{ url_for('tools') }}" class="btn">Cancel</a>
</div>

<div style="max-width: 800px;">
    <!-- Bunnings Search -->
    <div style="background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%); border: 2px solid var(--border); padding: 25px; margin-bottom: 30px;">
        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: var(--primary);">üîç Quick Search Bunnings</h3>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="bunnings-search" class="form-input"
                   placeholder="e.g., Ryobi drill, DeWalt saw, Makita sander..."
                   style="flex: 1;">
            <button type="button" onclick="searchBunnings()" class="btn btn-primary">Search</button>
        </div>
        <div id="search-status" style="margin-top: 10px; font-size: 13px; color: var(--text-secondary);"></div>

        <!-- Search Results -->
        <div id="search-results" style="margin-top: 20px; display: none;">
            <div style="font-weight: 600; margin-bottom: 10px; color: var(--primary);">Search Results:</div>
            <div id="results-container" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <form method="POST" action="{{ url_for('add_tool') }}" enctype="multipart/form-data">
        <div style="background: var(--bg-secondary); border: 2px solid var(--border); padding: 30px;">
            
            <div class="form-group">
                <label class="form-label" for="name">Tool Name *</label>
                <input type="text" id="name" name="name" class="form-input" required>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label class="form-label" for="brand">Brand</label>
                    <input type="text" id="brand" name="brand" class="form-input" list="brand-suggestions"
                           autocomplete="off" placeholder="Start typing...">
                    <datalist id="brand-suggestions"></datalist>
                </div>

                <div class="form-group">
                    <label class="form-label" for="model">Model</label>
                    <input type="text" id="model" name="model" class="form-input" list="model-suggestions"
                           autocomplete="off" placeholder="Start typing...">
                    <datalist id="model-suggestions"></datalist>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label class="form-label" for="category">Category</label>
                    <select id="category" name="category" class="form-select">
                        <option value="">Select Category</option>
                        <option value="Power Tool">Power Tool</option>
                        <option value="Hand Tool">Hand Tool</option>
                        <option value="Measuring Tool">Measuring Tool</option>
                        <option value="Cutting Tool">Cutting Tool</option>
                        <option value="Fastening Tool">Fastening Tool</option>
                        <option value="Sanding Tool">Sanding Tool</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="condition">Condition</label>
                    <select id="condition" name="condition" class="form-select">
                        <option value="New">New</option>
                        <option value="Good" selected>Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Needs Repair">Needs Repair</option>
                    </select>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label class="form-label" for="purchase_date">Purchase Date</label>
                    <input type="date" id="purchase_date" name="purchase_date" class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="purchase_price">Purchase Price (NZD)</label>
                    <input type="number" id="purchase_price" name="purchase_price" 
                           class="form-input" step="0.01" min="0">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="location">Storage Location</label>
                <input type="text" id="location" name="location" class="form-input" 
                       placeholder="e.g., Workshop drawer 3, Toolbox, Shelf A">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="bunnings_url">Bunnings URL</label>
                <input type="url" id="bunnings_url" name="bunnings_url" class="form-input"
                       placeholder="https://www.bunnings.co.nz/...">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="manual_url">Manual/Datasheet URL</label>
                <input type="url" id="manual_url" name="manual_url" class="form-input"
                       placeholder="https://...">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="notes">Notes</label>
                <textarea id="notes" name="notes" class="form-textarea" 
                          placeholder="Additional information, maintenance notes, specifications..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="image">Tool Image</label>
                <input type="file" id="image" name="image" class="form-input" accept="image/*">
                <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                    Accepted formats: PNG, JPG, GIF, WebP (Max 16MB)
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button type="submit" class="btn btn-primary">Add Tool</button>
                <a href="{{ url_for('tools') }}" class="btn">Cancel</a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load autocomplete data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadBrandSuggestions();
    loadModelSuggestions();

    // Update model suggestions when brand changes
    document.getElementById('brand').addEventListener('input', function() {
        loadModelSuggestions(this.value);
    });

    // Allow Enter key to trigger search
    document.getElementById('bunnings-search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchBunnings();
        }
    });
});

// Load brand suggestions from database
function loadBrandSuggestions() {
    fetch('/api/autocomplete/brands')
        .then(response => response.json())
        .then(brands => {
            const datalist = document.getElementById('brand-suggestions');
            datalist.innerHTML = '';
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                datalist.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading brand suggestions:', error));
}

// Load model suggestions from database
function loadModelSuggestions(brand = '') {
    const url = brand ? `/api/autocomplete/models?brand=${encodeURIComponent(brand)}` : '/api/autocomplete/models';
    fetch(url)
        .then(response => response.json())
        .then(models => {
            const datalist = document.getElementById('model-suggestions');
            datalist.innerHTML = '';
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                datalist.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading model suggestions:', error));
}

// Search Bunnings
function searchBunnings() {
    const query = document.getElementById('bunnings-search').value.trim();
    if (!query) {
        document.getElementById('search-status').textContent = 'Please enter a search term';
        return;
    }

    const statusEl = document.getElementById('search-status');
    const resultsEl = document.getElementById('search-results');
    const containerEl = document.getElementById('results-container');

    statusEl.textContent = 'Searching Bunnings...';
    statusEl.style.color = 'var(--primary)';
    resultsEl.style.display = 'none';

    fetch(`/search/bunnings?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.products.length > 0) {
                statusEl.textContent = `Found ${data.products.length} products`;
                statusEl.style.color = 'var(--primary)';
                containerEl.innerHTML = '';

                data.products.forEach(product => {
                    const card = createProductCard(product);
                    containerEl.appendChild(card);
                });

                resultsEl.style.display = 'block';
            } else if (data.success && data.products.length === 0) {
                if (data.message) {
                    statusEl.innerHTML = data.message;
                } else {
                    statusEl.textContent = 'No products found. Try a different search term.';
                }
                statusEl.style.color = 'var(--text-secondary)';
                resultsEl.style.display = 'none';
            } else {
                statusEl.textContent = `Error: ${data.error || 'Failed to search Bunnings'}`;
                statusEl.style.color = '#ff6b6b';
                resultsEl.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error searching Bunnings:', error);
            statusEl.textContent = 'Failed to connect to Bunnings. Please try again.';
            statusEl.style.color = '#ff6b6b';
            resultsEl.style.display = 'none';
        });
}

// Create product card element
function createProductCard(product) {
    const card = document.createElement('div');
    card.style.cssText = `
        background: var(--bg-primary);
        border: 1px solid var(--border);
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        gap: 15px;
        align-items: start;
    `;
    card.onmouseover = () => card.style.borderColor = 'var(--primary)';
    card.onmouseout = () => card.style.borderColor = 'var(--border)';
    card.onclick = () => fillFormFromProduct(product);

    const imageHtml = product.image_url
        ? `<img src="${product.image_url}" alt="${product.name}" style="width: 80px; height: 80px; object-fit: contain; border: 1px solid var(--border);">`
        : '<div style="width: 80px; height: 80px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; border: 1px solid var(--border);">üîß</div>';

    const priceHtml = product.price
        ? `<div style="font-weight: 600; color: var(--primary); margin-top: 5px;">$${product.price.toFixed(2)} NZD</div>`
        : '';

    const brandHtml = product.brand
        ? `<div style="color: var(--text-secondary); font-size: 13px;">Brand: ${product.brand}</div>`
        : '';

    card.innerHTML = `
        ${imageHtml}
        <div style="flex: 1;">
            <div style="font-weight: 500; margin-bottom: 5px;">${product.name}</div>
            ${brandHtml}
            ${priceHtml}
            <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                Click to auto-fill form ‚ûú
            </div>
        </div>
    `;

    return card;
}

// Fill form from selected product
function fillFormFromProduct(product) {
    // Fill tool name
    document.getElementById('name').value = product.name;

    // Fill brand if available
    if (product.brand) {
        document.getElementById('brand').value = product.brand;
        loadModelSuggestions(product.brand);
    }

    // Fill price if available
    if (product.price) {
        document.getElementById('purchase_price').value = product.price;
    }

    // Fill Bunnings URL
    if (product.url) {
        document.getElementById('bunnings_url').value = product.url;
    }

    // Scroll to form
    document.getElementById('name').scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Visual feedback
    const statusEl = document.getElementById('search-status');
    statusEl.textContent = '‚úì Form filled! Review and adjust as needed, then submit.';
    statusEl.style.color = 'var(--primary)';

    // Highlight the name field
    const nameField = document.getElementById('name');
    nameField.style.background = 'rgba(255, 184, 0, 0.1)';
    nameField.style.borderColor = 'var(--primary)';
    setTimeout(() => {
        nameField.style.background = '';
        nameField.style.borderColor = '';
    }, 2000);
}
</script>
{% endblock %}
